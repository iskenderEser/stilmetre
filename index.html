<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sosyal Stil Belirleme GÃ¶zlem Formu</title>
  <meta name="description" content="GÃ¶zleme dayalÄ± sosyal stil belirleme formu." />

  <style>
    :root{
      --bg:#ffffff;
      --text:#121212;
      --muted:#5f6368;
      --border:#e6e6e6;
      --soft:#f7f7f8;
      --shadow: 0 8px 24px rgba(0,0,0,.08);
      --radius: 16px;
      --gap: 14px;

      --red:#d32f2f;
      --blue:#1565c0;
      --green:#2e7d32;
      --yellow:#f9a825;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text);
      background:linear-gradient(180deg, #fff 0%, #fafafa 100%);
      padding: 20px 14px 60px;
    }

    .wrap{ max-width: 1100px; margin:0 auto; }

    header{
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom: 16px;
    }

    h1{
      font-size: clamp(20px, 2.4vw, 28px);
      margin:0;
      letter-spacing:-.2px;
    }
    .sub{
      margin:6px 0 0;
      color:var(--muted);
      line-height:1.4;
      max-width: 72ch;
      font-size: 14px;
    }

    .topActions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    button{
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      box-shadow: 0 1px 0 rgba(0,0,0,.02);
      font-weight: 600;
      font-size: 13px;
    }
    button:hover{ background:var(--soft); }
    button:active{ transform: translateY(1px); }

/* Button variants */
.btnPrimary{
  background: #111;
  color:#fff;
  border-color:#111;
}
.btnPrimary:hover{ background:#1f1f1f; }
.btnSecondary{
  background:#fff;
  color:var(--text);
}

/* Modal */
.modalOverlay{
  position:fixed;
  inset:0;
  background: rgba(0,0,0,.45);
  display:none;
  align-items:center;
  justify-content:center;
  padding: 18px 14px;
  z-index: 999;
}
.modalOverlay.show{ display:flex; }

.modal{
  width:min(980px, 100%);
  background:#fff;
  border:1px solid var(--border);
  border-radius: 18px;
  box-shadow: 0 18px 60px rgba(0,0,0,.25);
  overflow:hidden;
  display:flex;
  flex-direction:column;
  max-height: calc(100vh - 36px);
}
.modalHead{
  padding: 14px 16px;
  border-bottom:1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  background:#fff;
}
.modalTitle{
  margin:0;
  font-size: 14px;
  font-weight: 900;
  letter-spacing:-.1px;
}
.modalBody{
  padding: 14px 16px 16px;
  display:grid;
  grid-template-columns: 1fr;
  gap: 12px;
  overflow:auto;
}
@media(min-width: 920px){
  .modalBody{ grid-template-columns: .42fr .58fr; }
}
.formBlock{
  border:1px solid var(--border);
  border-radius: 14px;
  padding: 12px;
  background: var(--soft);
  display:flex;
  flex-direction:column;
  gap:10px;
}
.formRow{
  display:flex;
  flex-direction:column;
  gap:6px;
}
.formRow label{
  font-size: 12px;
  color: var(--muted);
  font-weight: 700;
}
.formRow input[type="text"],
.formRow input[type="date"]{
  width:100%;
  padding:10px 10px;
  border:1px solid var(--border);
  border-radius: 12px;
  font-size: 13px;
  background:#fff;
}
.toggleRow{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 10px;
  border:1px dashed var(--border);
  border-radius: 12px;
  background:#fff;
}
.toggleRow input{ transform: scale(1.1); }
.previewBlock{
  border:1px solid var(--border);
  border-radius: 14px;
  overflow:hidden;
  background:#fff;
  min-height: 360px;
  position:relative;
}
.previewFrame{
  width:100%;
  height: min(64vh, 640px);
  border:0;
  display:block;
  background:#fff;
}
.loading{
  position:absolute;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  gap:8px;
  background: rgba(255,255,255,.8);
  color: var(--muted);
  font-weight:800;
  font-size: 13px;
}
.loading.show{ display:flex; }
.spinner{
  width: 22px; height: 22px;
  border: 3px solid #ddd;
  border-top-color: #111;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}
@keyframes spin{ to { transform: rotate(360deg);} }

.modalFoot{
  padding: 12px 16px;
  border-top:1px solid var(--border);
  display:flex;
  justify-content:flex-end;
  gap:10px;
  flex-wrap:wrap;
  background:#fff;
}

.toast{
  position: fixed;
  right: 14px;
  bottom: 14px;
  background: #111;
  color:#fff;
  padding: 10px 12px;
  border-radius: 12px;
  font-weight: 800;
  font-size: 13px;
  box-shadow: 0 12px 30px rgba(0,0,0,.22);
  display:none;
  z-index: 1000;
}
.toast.show{ display:block; }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: var(--gap);
      margin-top: 14px;
    }
    @media(min-width: 960px){
      .grid{ grid-template-columns: 1.1fr .9fr; }
    }

    .card{
      background: var(--bg);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding: 14px 16px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      background: #fff;
    }
    .cardTitle{
      margin:0;
      font-size: 15px;
      letter-spacing:-.1px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size: 12px;
      color: var(--muted);
      padding: 6px 10px;
      border:1px solid var(--border);
      border-radius: 999px;
      background: #fff;
      white-space: nowrap;
    }
    .cardBody{ padding: 12px 12px 14px; }

    /* Accordion */
    .accordion{
      display:flex;
      flex-direction:column;
      gap: 12px;
    }
    details.group{
      border:1px solid var(--border);
      border-radius: 14px;
      background:#fff;
      overflow:hidden;
    }
    summary.groupHead{
      list-style:none;
      cursor:pointer;
      padding: 12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      user-select:none;
    }
    summary.groupHead::-webkit-details-marker{ display:none; }

    .groupName{
      font-weight:900;
      font-size: 13px;
      margin:0;
    }
    .count{
      font-weight:900;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: var(--soft);
      border: 1px solid var(--border);
      min-width: 54px;
      text-align:center;
    }

    .items{
      padding: 10px 10px 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      border-top:1px solid var(--border);
    }
    label.item{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding: 10px 10px;
      border-radius: 12px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
    }
    label.item:hover{ background: var(--soft); }
    input[type="checkbox"]{
      margin-top: 2px;
      transform: scale(1.1);
      accent-color: #111;
    }
    .txt{
      font-size: 13px;
      line-height: 1.35;
    }

    .resultBox{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .resultBig{
      padding: 14px 16px;
      border-radius: 16px;
      border:1px solid var(--border);
      background:#fff;
    }
    .resultTitle{
      margin:0;
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
      letter-spacing: .2px;
      text-transform: uppercase;
    }
    .resultMeta{
      margin:6px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height:1.4;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border-radius: 999px;
      padding: 8px 12px;
      border:1px solid var(--border);
      background:#fff;
      font-weight: 900;
      font-size: 13px;
      width: fit-content;
    }
    .dot{
      width:10px; height:10px;
      border-radius: 50%;
      background:#999;
      flex: 0 0 auto;
    }

    .miniRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 10px;
    }

    .warn{
      border-left: 4px solid #999;
      padding: 10px 12px;
      background: #fff;
      border:1px solid var(--border);
      border-radius: 12px;
    }
    .note{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.45;
      padding: 0 2px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Sosyal Stil Belirleme GÃ¶zlem Formu</h1>
        <p class="sub">
          Bu araÃ§ test/anket deÄŸildir; <b>gÃ¶zleme dayalÄ±</b> bir formdur. Uygun ifadeleri iÅŸaretleyin.
          Ä°ÅŸaretlenenler sayÄ±lÄ±r; <b>en yÃ¼ksek iki grup</b> stili verir.
          <br><b>Limit:</b> T+A en fazla 15, C+E en fazla 15.
        </p>
      </div>

        <div class="topActions">
    <button id="btnReset" type="button">TÃ¼mÃ¼nÃ¼ Temizle</button>
    <button id="btnCopy" type="button" class="btnSecondary">ðŸ“‹ Kopyala</button>
    <button id="btnPdf" type="button" class="btnPrimary">ðŸ“„ PDF OluÅŸtur</button>
  </div>
</header>

    <div class="grid">

      <section class="card">
        <div class="cardHead">
          <h2 class="cardTitle">GÃ¶zlem Ä°fadeleri</h2>
          <div class="pill" id="totalChecked">Ä°ÅŸaretli: 0</div>
        </div>

        <div class="cardBody">
          <div class="accordion" id="groupsRoot"></div>
        </div>
      </section>

      <aside class="card">
        <div class="cardHead">
          <h2 class="cardTitle">SonuÃ§</h2>
          <div class="pill" id="topTwoPill">Top 2: â€”</div>
        </div>

        <div class="cardBody resultBox">
          <div class="resultBig">
            <p class="resultTitle">BaskÄ±n Stil</p>
            <div class="miniRow">
              <span class="badge">
                <span class="dot" id="styleDot"></span>
                <span id="styleName">â€”</span>
              </span>
            </div>
            <p class="resultMeta" id="styleMeta">Ä°ÅŸaretleme yaptÄ±kÃ§a stil otomatik hesaplanÄ±r.</p>
          </div>

          <div class="resultBig">
            <p class="resultTitle">Grup SayÄ±mlarÄ±</p>
            <p class="resultMeta" id="countsText">T: 0 â€¢ A: 0 â€¢ C: 0 â€¢ E: 0</p>

            <div class="warn note" id="limitNote" style="display:none;"></div>
            <div class="warn note" id="edgeNote" style="display:none;"></div>
          </div>

          <div class="note">
            EÅŸleÅŸme:<br/>
            <b>T+C</b> â†’ YÃ¶nlendirici (KÄ±rmÄ±zÄ±) â€¢ <b>A+C</b> â†’ Analitik (Mavi) â€¢
            <b>A+E</b> â†’ CanayakÄ±n (YeÅŸil) â€¢ <b>T+E</b> â†’ Ä°fadeci (SarÄ±)
          </div>
        </div>
      </aside>

    </div>
  </div>


<!-- PDF Ã–nizleme Modal -->
<div class="modalOverlay" id="pdfModal" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="pdfModalTitle">
    <div class="modalHead">
      <h3 class="modalTitle" id="pdfModalTitle">PDF Ã–nizleme</h3>
      <button type="button" id="btnCloseModal" class="btnSecondary">Kapat</button>
    </div>

    <div class="modalBody">
      <div class="formBlock">
        <div class="toggleRow">
          <input type="checkbox" id="metaToggle" />
          <label for="metaToggle" style="cursor:pointer; margin:0;">
            Raporunuza <b>isim</b> ve <b>tarih</b> eklemek ister misiniz?
          </label>
        </div>

        <div class="formRow">
          <label for="metaName">Ä°sim (opsiyonel)</label>
          <input id="metaName" type="text" placeholder="Ã–rn: BM AdÄ± SoyadÄ± / Temsilci AdÄ± SoyadÄ±" disabled />
        </div>

        <div class="formRow">
          <label for="metaDate">Tarih</label>
          <input id="metaDate" type="date" disabled />
        </div>

        <div class="note">
          VarsayÄ±lan baÅŸlÄ±k: <b>FAST S4 GÃ¶zlem Raporu â€“ (otomatik tarih)</b><br/>
          Ä°sterseniz bu alanda kiÅŸiselleÅŸtirebilirsiniz.
        </div>

        <button type="button" id="btnRebuildPdf" class="btnPrimary">PDFâ€™i Yenile</button>
      </div>

      <div class="previewBlock">
        <div class="loading" id="pdfLoading">
          <div class="spinner"></div>
          PDF hazÄ±rlanÄ±yorâ€¦
        </div>
        <iframe class="previewFrame" id="pdfFrame" title="PDF Ã–nizleme"></iframe>
      </div>
    </div>

    <div class="modalFoot">
      <button type="button" id="btnDownloadPdf" class="btnPrimary">Ä°ndir</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

  <!-- pdfmake CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

  <script>
    // --- Data (s4 GruplandÄ±rÄ±lmÄ±ÅŸ_3rd) ---
    const DATA = [
      {
        key: "T",
        title: "SÃ¶yleyen Ä°ddiacÄ± (T)",
        items: [
          "Olaylar karÅŸÄ±sÄ±nda dÃ¼ÅŸÃ¼ncelerini hemen ifade etmek ister.",
          "Kendisine verilen bir gÃ¶revi bir an Ã¶nce yapmak ister.",
          "Hayatta risk almak gerektiÄŸini dÃ¼ÅŸÃ¼nÃ¼r.",
          "Ã–nce kendisi el uzatÄ±r.",
          "Bir karmaÅŸa olduÄŸunda kontrolÃ¼ ele almak ister.",
          "Ä°letiÅŸimlerde dÄ±ÅŸa dÃ¶nÃ¼k ve aÃ§Ä±k sÃ¶zlÃ¼dÃ¼r.",
          "SonuÃ§larÄ±n kendisi iÃ§in Ã¶nemli olduÄŸunu dÃ¼ÅŸÃ¼nÃ¼r.",
          "Fikirlerini tartÄ±ÅŸarak ikna etmeyi tercih eder.",
          "Ã‡ok sabÄ±rlÄ± olmadÄ±ÄŸÄ± sÃ¶ylenir.",
          "Rekabeti sever.",
          "Grup iÃ§inde Ã¶n planda olmak ister.",
          "Ã‡abuk karar verir.",
          "Grubun kendisini takip etmesini ister.",
          "GÃ¶rÃ¼ÅŸlerini ve dÃ¼ÅŸÃ¼ncelerini hemen paylaÅŸÄ±r.",
          "Ä°ÅŸleri kendi yÃ¶ntemleriyle yapmayÄ± tercih eder."
        ]
      },
      {
        key: "A",
        title: "Soran Ä°ddiacÄ± (A)",
        items: [
          "Her akla geleni sÃ¶ylemez.",
          "Kendisine verilen bir gÃ¶revi yerine getirirken acele etmemek gerektiÄŸini dÃ¼ÅŸÃ¼nÃ¼r.",
          "Hayatta riskleri Ã¶ngÃ¶rmenin Ã¶nemli olduÄŸunu dÃ¼ÅŸÃ¼nÃ¼r.",
          "Ã–nce karÅŸÄ±sÄ±ndakinin elini uzatmasÄ±nÄ± bekler.",
          "Bir karmaÅŸa olduÄŸunda Ã¶nce izlemeyi tercih eder.",
          "Ä°letiÅŸimlerde dinlemeyi ve izlemeyi tercih eder.",
          "SÃ¼reÃ§leri ve yÃ¶ntemleri bilmek ister.",
          "Fikirlerini bir kere sÃ¶yler ve dinler.",
          "OldukÃ§a sabÄ±rlÄ±dÄ±r.",
          "Ä°ÅŸ birliÄŸi yapmayÄ± tercih eder.",
          "Grup iÃ§inde Ã¶n planda olmayÄ± tercih etmez.",
          "Karar vermek iÃ§in zamana ihtiyaÃ§ duyar.",
          "Gruba gÃ¶re hareket etmeyi tercih eder.",
          "GÃ¶rÃ¼ÅŸlerini ve dÃ¼ÅŸÃ¼ncelerini hemen ifade etmeyi tercih etmez.",
          "YapÄ±lanlarÄ± onaylamayÄ± tercih eder."
        ]
      },
      {
        key: "C",
        title: "DÃ¼ÅŸÃ¼k Tepkisel (C)",
        items: [
          "Ä°liÅŸkilerde mesafelidir.",
          "DuygularÄ±nÄ± ifade etmeyi pek tercih etmez.",
          "Olur olmadÄ±k yerde ÅŸaka yapÄ±lmasÄ±ndan hoÅŸlanmaz.",
          "GerÃ§eklere dayanarak konuÅŸur.",
          "Bir gÃ¶rev verildiÄŸinde yalnÄ±z Ã§alÄ±ÅŸmayÄ± tercih eder.",
          "KiÅŸilerin olaylar karÅŸÄ±sÄ±nda dÃ¼ÅŸÃ¼ndÃ¼klerini anlamaya Ã§alÄ±ÅŸÄ±r.",
          "Ä°liÅŸkilerinde resmiyeti tercih eder.",
          "Ä°ÅŸlerin yÃ¼rÃ¼mesi iÃ§in herkesin iÅŸini yapmasÄ± gerektiÄŸini dÃ¼ÅŸÃ¼nÃ¼r.",
          "Ã‡oÄŸu zaman Ã§evresinde olup bitenlerden en son haberdar olur.",
          "Daha Ã§ok gÃ¶rev odaklÄ± biri olduÄŸunu dÃ¼ÅŸÃ¼nÃ¼r.",
          "Ã‡evresinin kendisini sokulgan olarak tanÄ±mlamasÄ±ndan hoÅŸlanmaz.",
          "Ä°liÅŸkilerinde duygularÄ±n ikinci planda olduÄŸunu dÃ¼ÅŸÃ¼nÃ¼r.",
          "KiÅŸilere karÅŸÄ± isteklerini sÃ¶ylemekten Ã§ekinmez.",
          "Ä°letiÅŸimlerinde temkinli ve Ã¶lÃ§Ã¼lÃ¼dÃ¼r.",
          "DuygularÄ±n anlaÅŸÄ±lmasÄ± gerektiÄŸini dÃ¼ÅŸÃ¼nÃ¼r."
        ]
      },
      {
        key: "E",
        title: "YÃ¼ksek Tepkisel (E)",
        items: [
          "Ä°liÅŸkilerde sÄ±cak ve arkadaÅŸÃ§a yaklaÅŸtÄ±ÄŸÄ±nÄ± dÃ¼ÅŸÃ¼nÃ¼r.",
          "DuygularÄ± ifade etmenin iletiÅŸim iÃ§in Ã¶nemli olduÄŸuna inanÄ±r.",
          "ArkadaÅŸlarÄ±yla ÅŸakalaÅŸmayÄ± sever.",
          "GÃ¶rÃ¼ÅŸlerini Ã¶ne sÃ¼rerek konuÅŸur.",
          "Bir gÃ¶rev verildiÄŸinde ortak Ã§alÄ±ÅŸmayÄ± tercih eder.",
          "KiÅŸilerin olaylar karÅŸÄ±sÄ±nda hissettiklerini anlamaya Ã§alÄ±ÅŸÄ±r.",
          "Ã‡evresindeki birÃ§ok kiÅŸiyle samimi olduÄŸunu dÃ¼ÅŸÃ¼nÃ¼r.",
          "Ä°ÅŸlerini kiÅŸisel iliÅŸkilerle halletmeyi tercih eder.",
          "Ã‡evresinde olup bitenlerle ilgili Ã§oÄŸu kiÅŸiden Ã¶nce haberdar olur.",
          "Daha Ã§ok iliÅŸki odaklÄ± biri olduÄŸunu dÃ¼ÅŸÃ¼nÃ¼r.",
          "Ã‡evresindeki kiÅŸilere karÅŸÄ± yakÄ±n ve aÃ§Ä±ktÄ±r.",
          "Ä°liÅŸkilerinde Ã¶nce duygularÄ± anlamak ister.",
          "KiÅŸilere karÅŸÄ± anlayÄ±ÅŸlÄ±dÄ±r.",
          "Ä°letiÅŸimlerinde zorlayÄ±cÄ±dÄ±r.",
          "DuygularÄ±n paylaÅŸÄ±lmasÄ± gerektiÄŸine inanÄ±r."
        ]
      }
    ];

    // Quadrant mapping
    const STYLE_MAP = {
      "T+C": { name: "YÃ¶nlendirici", color: "var(--red)" },
      "A+C": { name: "Analitik",     color: "var(--blue)" },
      "A+E": { name: "CanayakÄ±n",    color: "var(--green)" },
      "T+E": { name: "Ä°fadeci",      color: "var(--yellow)" }
    };

    // --- Helpers ---
    const qs = (s, el=document) => el.querySelector(s);
    const qsa = (s, el=document) => Array.from(el.querySelectorAll(s));

    const groupsRoot = qs("#groupsRoot");
    const totalCheckedEl = qs("#totalChecked");
    const countsText = qs("#countsText");
    const topTwoPill = qs("#topTwoPill");
    const styleNameEl = qs("#styleName");
    const styleDotEl = qs("#styleDot");
    const styleMetaEl = qs("#styleMeta");
    const edgeNoteEl = qs("#edgeNote");
    const limitNoteEl = qs("#limitNote");

    // --- LIMIT RULES ---
    const AXIS_CAP = 15; // T+A max 15, C+E max 15

    function showLimit(msg){
      limitNoteEl.style.display = "block";
      limitNoteEl.textContent = msg;
      clearTimeout(showLimit._t);
      showLimit._t = setTimeout(() => {
        limitNoteEl.style.display = "none";
        limitNoteEl.textContent = "";
      }, 1600);
    }

    function axisTotal(axisKey){
      const groups = axisKey === "TA" ? ["T","A"] : ["C","E"];
      return qsa('input[type="checkbox"][data-group]')
        .filter(ch => ch.checked && groups.includes(ch.dataset.group))
        .length;
    }

    function buildUI(){
      groupsRoot.innerHTML = "";

      DATA.forEach((g, gi) => {
        const details = document.createElement("details");
        details.className = "group";
        if (gi === 0) details.open = true;

        details.innerHTML = `
          <summary class="groupHead">
            <p class="groupName">${g.title}</p>
            <div class="count" id="count-${g.key}">0</div>
          </summary>
          <div class="items" id="items-${g.key}"></div>
        `;

        // âœ… TEK-AÃ‡IK ACCORDION: summary click'i biz yÃ¶netiyoruz
        const summary = details.querySelector("summary");
        summary.addEventListener("click", (ev) => {
          ev.preventDefault(); // native toggle'Ä± iptal
          const willOpen = !details.open;

          // diÄŸer aÃ§Ä±k olanlarÄ± kapat (iÅŸaretler kalÄ±r)
          qsa("details.group", groupsRoot).forEach(d => {
            if (d !== details) d.open = false;
          });

          // bunu aÃ§/kapat
          details.open = willOpen;
        });

        const itemsEl = details.querySelector(`#items-${g.key}`);
        g.items.forEach((txt, idx) => {
          const id = `${g.key}-${idx}`;
          const label = document.createElement("label");
          label.className = "item";
          label.innerHTML = `
            <input type="checkbox" data-group="${g.key}" id="${id}" />
            <span class="txt">${txt}</span>
          `;
          itemsEl.appendChild(label);
        });

        groupsRoot.appendChild(details);
      });

      // Limit + sayÄ±m (event delegation)
      groupsRoot.addEventListener("change", (e) => {
        const target = e.target;
        if (!(target instanceof HTMLInputElement) || target.type !== "checkbox") return;

        if (target.checked) {
          const g = target.dataset.group; // T/A/C/E
          const axis = (g === "T" || g === "A") ? "TA" : "CE";
          const total = axisTotal(axis);

          if (total > AXIS_CAP) {
            target.checked = false; // geri al
            showLimit(axis === "TA"
              ? "Limit: SÃ¶yleyen Ä°ddiacÄ± (T) + Soran Ä°ddiacÄ± (A) toplamÄ± en fazla 15 olabilir."
              : "Limit: DÃ¼ÅŸÃ¼k Tepkisel (C) + YÃ¼ksek Tepkisel (E) toplamÄ± en fazla 15 olabilir."
            );
          }
        }
        recalc();
      }, { passive: true });

      recalc();
    }

    function getCounts(){
      const counts = { T:0, A:0, C:0, E:0 };
      const checks = qsa('input[type="checkbox"][data-group]');
      for (const ch of checks){
        if (ch.checked) counts[ch.dataset.group]++;
      }
      return { counts, total: checks.filter(c => c.checked).length };
    }

    function pickTopTwoAcrossAxes(counts){
      const entries = Object.entries(counts)
        .map(([k,v]) => ({k, v}))
        .sort((a,b) => b.v - a.v);

      if (entries[0].v === 0) return { top: [], note: "" };

      const first = entries[0];
      const second = entries[1];

      const assertive = new Set(["T","A"]);
      const reactive  = new Set(["C","E"]);

      const sameAxis =
        (assertive.has(first.k) && assertive.has(second.k)) ||
        (reactive.has(first.k)  && reactive.has(second.k));

      if (!sameAxis){
        return { top: [first.k, second.k], note: "" };
      }

      // aynÄ± eksen Ã§Ä±karsa: en yÃ¼kseÄŸi tut, diÄŸer eksenden en yÃ¼ksek olan ile tamamla
      const needAxis = assertive.has(first.k) ? reactive : assertive;
      const fallback = entries.find(e => needAxis.has(e.k) && e.v > 0);

      if (fallback){
        return {
          top: [first.k, fallback.k],
          note: `Not: En yÃ¼ksek iki grup aynÄ± eksenden geldiÄŸi iÃ§in (${first.k} + ${second.k}), diÄŸer eksenden en yÃ¼ksek olan ile tamamlandÄ± (${fallback.k}).`
        };
      }

      return {
        top: [first.k],
        note: "Not: Stil iÃ§in iki eksenden de (T/A ve C/E) en az birer ifade iÅŸaretlenmelidir."
      };
    }

    function recalc(){
      const { counts, total } = getCounts();

      ["T","A","C","E"].forEach(k => {
        const el = qs(`#count-${k}`);
        if (el) el.textContent = counts[k];
      });

      totalCheckedEl.textContent = `Ä°ÅŸaretli: ${total}`;
      countsText.textContent = `T: ${counts.T} â€¢ A: ${counts.A} â€¢ C: ${counts.C} â€¢ E: ${counts.E}`;

      const { top, note } = pickTopTwoAcrossAxes(counts);
      edgeNoteEl.style.display = note ? "block" : "none";
      edgeNoteEl.textContent = note;

      if (top.length >= 2){
        const pair = `${top[0]}+${top[1]}`;
        const pair2 = `${top[1]}+${top[0]}`;
        const style = STYLE_MAP[pair] || STYLE_MAP[pair2];

        topTwoPill.textContent = `Top 2: ${top[0]} + ${top[1]}`;

        if (style){
          styleNameEl.textContent = style.name;
          styleDotEl.style.background = style.color;
          styleMetaEl.textContent = `Kombinasyon: ${top[0]} + ${top[1]}`;
        } else {
          styleNameEl.textContent = "â€”";
          styleDotEl.style.background = "#999";
          styleMetaEl.textContent = "Kombinasyon tanÄ±mlanamadÄ±.";
        }
      } else if (top.length === 1){
        topTwoPill.textContent = `Top 2: ${top[0]} + â€”`;
        styleNameEl.textContent = "â€”";
        styleDotEl.style.background = "#999";
        styleMetaEl.textContent = "Stil iÃ§in diÄŸer eksenden de iÅŸaretleme gerekir.";
      } else {
        topTwoPill.textContent = "Top 2: â€”";
        styleNameEl.textContent = "â€”";
        styleDotEl.style.background = "#999";
        styleMetaEl.textContent = "Ä°ÅŸaretleme yaptÄ±kÃ§a stil otomatik hesaplanÄ±r.";
      }
    }

    // Actions
    qs("#btnReset").addEventListener("click", () => {
      qsa('input[type="checkbox"][data-group]').forEach(c => c.checked = false);
      recalc();
    });



// -----------------------
// UI Feedback (toast)
// -----------------------
const toastEl = qs("#toast");
function toast(msg, ms=1200){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  clearTimeout(toast._t);
  toast._t = setTimeout(() => toastEl.classList.remove("show"), ms);
}

// -----------------------
// Selected items collector
// -----------------------
function getSelectedGrouped(){
  const result = [];
  for (const g of DATA){
    const checked = qsa(`input[type="checkbox"][data-group="${g.key}"]`)
      .map((ch, idx) => ({ ch, idx }))
      .filter(x => x.ch.checked)
      .map(x => {
        // label structure: input + span.txt
        const label = x.ch.closest("label.item");
        const txt = label ? label.querySelector(".txt")?.textContent?.trim() : "";
        return txt || "";
      })
      .filter(Boolean);

    result.push({ key: g.key, title: g.title, items: checked });
  }
  return result;
}

function getStyleResult(){
  const { counts } = getCounts();
  const { top, note } = pickTopTwoAcrossAxes(counts);

  let styleName = "â€”";
  let styleColor = "#999";
  let combo = "â€”";

  if (top.length >= 2){
    const pair = `${top[0]}+${top[1]}`;
    const pair2 = `${top[1]}+${top[0]}`;
    const style = STYLE_MAP[pair] || STYLE_MAP[pair2];
    combo = `${top[0]} + ${top[1]}`;
    if (style){
      styleName = style.name;
      // style.color is a CSS var; resolve to hex-ish via computed style fallback
      styleColor = getComputedStyle(document.documentElement).getPropertyValue(
        style.name === "YÃ¶nlendirici" ? "--red" :
        style.name === "Analitik" ? "--blue" :
        style.name === "CanayakÄ±n" ? "--green" : "--yellow"
      ).trim() || "#111";
    }
  }

  return { counts, top, note, styleName, styleColor, combo };
}

function formatDateTR(d){
  const pad = (n) => String(n).padStart(2, "0");
  return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()}`;
}

// -----------------------
// PDFMake setup + build
// -----------------------
// pdfmake vfs_fonts includes Roboto; Roboto has Turkish glyph coverage.
// Still, we explicitly set the default font for consistency.
if (window.pdfMake && pdfMake.vfs){
  pdfMake.fonts = {
    Roboto: {
      normal: "Roboto-Regular.ttf",
      bold: "Roboto-Medium.ttf",
      italics: "Roboto-Italic.ttf",
      bolditalics: "Roboto-MediumItalic.ttf"
    }
  };
}

function buildDocDefinition(meta){
  const sel = getSelectedGrouped();
  const r = getStyleResult();
  const now = new Date();

  const titleDate = meta?.dateStr || formatDateTR(now);
  const baseTitle = meta?.title?.trim()
    ? meta.title.trim()
    : `FAST S4 GÃ¶zlem Raporu â€“ ${titleDate}`;

  const whoLine = meta?.name?.trim() ? `HazÄ±rlayan: ${meta.name.trim()}` : "";

  // Page 1: summary
  const page1 = [
    { text: baseTitle, style: "h1" },
    ...(whoLine ? [{ text: whoLine, style: "sub" }] : []),
    { text: "", margin: [0,6,0,0] },

    {
      columns: [
        {
          width: "*",
          stack: [
            { text: "Sosyal Stil Sonucu", style: "h2" },
            {
              table: {
                widths: ["*"],
                body: [[
                  { text: r.styleName, color: r.styleColor, style: "styleBig" }
                ]]
              },
              layout: "noBorders",
              margin: [0,2,0,6]
            },
            { text: `Kombinasyon: ${r.combo}`, style: "sub" },
            ...(r.note ? [{ text: r.note, style: "noteBox" }] : [])
          ]
        },
        {
          width: 210,
          stack: [
            { text: "SayÄ±mlar", style: "h2" },
            {
              table: {
                widths: [32, "*"],
                body: [
                  [{ text: "T", style: "k" }, { text: String(r.counts.T), style: "v" }],
                  [{ text: "A", style: "k" }, { text: String(r.counts.A), style: "v" }],
                  [{ text: "C", style: "k" }, { text: String(r.counts.C), style: "v" }],
                  [{ text: "E", style: "k" }, { text: String(r.counts.E), style: "v" }],
                ]
              },
              layout: {
                hLineWidth: () => 0.6,
                vLineWidth: () => 0.6,
                hLineColor: () => "#e6e6e6",
                vLineColor: () => "#e6e6e6",
                paddingLeft: () => 8,
                paddingRight: () => 8,
                paddingTop: () => 6,
                paddingBottom: () => 6,
              }
            }
          ]
        }
      ],
      columnGap: 14
    },

    { text: "", margin: [0,10,0,0] },
    { text: "Ä°ÅŸaretlenen DavranÄ±ÅŸlar", style: "h2" },
  ];

  // Grouped selected items
  const groupsWithAny = sel.filter(g => g.items.length);
  if (!groupsWithAny.length){
    page1.push({ text: "HenÃ¼z seÃ§im yapÄ±lmadÄ±.", style: "sub" });
  } else {
    for (const g of groupsWithAny){
      page1.push({ text: g.title, style: "h3", margin: [0,8,0,4] });
      page1.push({
        ul: g.items,
        margin: [0,0,0,0],
        style: "list"
      });
    }
  }

  // Page 2: info (lightweight default content; can be replaced with your own later)
  const page2 = [
    { text: "Sosyal Stile Dair Notlar", style: "h1", pageBreak: "before" },
    { text: "Bu sayfa, rapora ek bilgi alanÄ± olarak tasarlanmÄ±ÅŸtÄ±r. Ä°sterseniz kendi iÃ§eriklerinizle geniÅŸletebilirsiniz.", style: "sub" },

    { text: "Ä°letiÅŸim Beklentileri (Genel)", style: "h2", margin: [0,10,0,4] },
    { ul: [
        "Net ve anlaÅŸÄ±lÄ±r bir iletiÅŸim dili kullanÄ±n.",
        "Somut Ã¶rneklerle gÃ¶zlemi destekleyin.",
        "Geri bildirim verirken davranÄ±ÅŸa odaklanÄ±n (kiÅŸiye deÄŸil)."
      ],
      style: "list"
    },

    { text: "GeliÅŸim Ã–nerileri (Genel)", style: "h2", margin: [0,10,0,4] },
    { ul: [
        "GÃ¼Ã§lÃ¼ gÃ¶rÃ¼nen davranÄ±ÅŸlarÄ± koruyun; zayÄ±f kalan eksende kÃ¼Ã§Ã¼k hedefler belirleyin.",
        "AynÄ± durumlarda farklÄ± yaklaÅŸÄ±m denemeleri yapÄ±n ve sonucu gÃ¶zlemleyin.",
        "BMâ€“Temsilci ikili Ã§alÄ±ÅŸmalarda Ã¶rnek cÃ¼mle/rol-play ile pekiÅŸtirin."
      ],
      style: "list"
    },

    { text: "Alt Bilgi", style: "h2", margin: [0,10,0,4] },
    { text: "Not: Bu araÃ§ bir kiÅŸilik testi deÄŸildir; sahadaki davranÄ±ÅŸ gÃ¶zlemlerini yapÄ±landÄ±rmak iÃ§in hazÄ±rlanmÄ±ÅŸtÄ±r.", style: "sub" }
  ];

  return {
    pageSize: "A4",
    pageMargins: [36, 34, 36, 38],
    defaultStyle: { font: "Roboto", fontSize: 10, lineHeight: 1.25 },
    footer: (currentPage, pageCount) => ({
      columns: [
        { text: `FAST S4 â€¢ ${formatDateTR(now)}`, alignment: "left", margin: [36, 0, 0, 0], color:"#666", fontSize: 9 },
        { text: `${currentPage}/${pageCount}`, alignment: "right", margin: [0, 0, 36, 0], color:"#666", fontSize: 9 }
      ]
    }),
    content: [...page1, ...page2],
    styles: {
      h1: { fontSize: 16, bold: true, margin: [0,0,0,6] },
      h2: { fontSize: 12, bold: true, margin: [0,6,0,6] },
      h3: { fontSize: 10.5, bold: true },
      sub:{ fontSize: 10, color:"#555", margin:[0,0,0,4] },
      styleBig:{ fontSize: 22, bold: true, alignment:"left" },
      list:{ fontSize: 10, margin:[0,0,0,0] },
      noteBox:{
        text: r.note,
        margin:[0,8,0,0],
        color:"#555",
        fontSize: 9,
        italics:true
      },
      k:{ bold:true, color:"#444" },
      v:{ bold:true, alignment:"right" }
    }
  };
}

// -----------------------
// Modal controls + preview
// -----------------------
const modalEl = qs("#pdfModal");
const frameEl = qs("#pdfFrame");
const loadingEl = qs("#pdfLoading");

const metaToggle = qs("#metaToggle");
const metaName = qs("#metaName");
const metaDate = qs("#metaDate");

let lastBlobUrl = null;
let lastFileName = null;

function openModal(){
  modalEl.classList.add("show");
  modalEl.setAttribute("aria-hidden", "false");
  document.body.style.overflow = "hidden";
}
function closeModal(){
  modalEl.classList.remove("show");
  modalEl.setAttribute("aria-hidden", "true");
  document.body.style.overflow = "";
}

function cleanupBlobUrl(){
  if (lastBlobUrl){
    URL.revokeObjectURL(lastBlobUrl);
    lastBlobUrl = null;
  }
}

function safeFileName(s){
  return (s || "FAST_S4_Gozlem_Raporu")
    .replace(/[\/:*?"<>|]+/g, "-")
    .replace(/\s+/g, " ")
    .trim();
}

async function buildAndPreviewPdf(){
  if (!window.pdfMake){
    alert("PDF oluÅŸturma kÃ¼tÃ¼phanesi yÃ¼klenemedi. Ä°nternet baÄŸlantÄ±nÄ±zÄ± kontrol edin.");
    return;
  }

  loadingEl.classList.add("show");
  frameEl.removeAttribute("src");

  const now = new Date();
  const dateVal = metaDate.value ? new Date(metaDate.value) : now;
  const dateStr = formatDateTR(dateVal);

  const useMeta = metaToggle.checked;
  const meta = {
    name: useMeta ? (metaName.value || "").trim() : "",
    dateStr: dateStr,
    title: useMeta
      ? `FAST S4 GÃ¶zlem Raporu â€“ ${dateStr}`
      : `FAST S4 GÃ¶zlem Raporu â€“ ${formatDateTR(now)}`
  };

  const dd = buildDocDefinition(meta);

  // Build blob
  cleanupBlobUrl();
  await new Promise((resolve) => {
    pdfMake.createPdf(dd).getBlob((blob) => {
      lastBlobUrl = URL.createObjectURL(blob);
      frameEl.src = lastBlobUrl;

      lastFileName = safeFileName(meta.title) + ".pdf";

      loadingEl.classList.remove("show");
      resolve();
    });
  });
}

// toggle enable/disable
metaToggle.addEventListener("change", () => {
  const on = metaToggle.checked;
  metaName.disabled = !on;
  metaDate.disabled = !on;
  if (on && !metaDate.value){
    // today
    const now = new Date();
    const pad = (n) => String(n).padStart(2,"0");
    metaDate.value = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}`;
  }
});

// close on overlay click
modalEl.addEventListener("click", (e) => {
  if (e.target === modalEl) closeModal();
});

qs("#btnCloseModal").addEventListener("click", closeModal);

// -----------------------
// Actions: Copy + PDF
// -----------------------
qs("#btnCopy").addEventListener("click", async () => {
  const r = getStyleResult();
  const sel = getSelectedGrouped();

  let styleLine = "Sosyal Stil: â€”";
  if (r.top.length >= 2){
    styleLine = `Sosyal Stil: ${r.styleName} (${r.combo})`;
  }

  const lines = [];
  lines.push("FAST S4 â€“ Sosyal Stil Belirleme GÃ¶zlem Formu");
  lines.push(`Tarih: ${formatDateTR(new Date())}`);
  lines.push(`SayÄ±m: T=${r.counts.T}, A=${r.counts.A}, C=${r.counts.C}, E=${r.counts.E}`);
  lines.push(styleLine);

  const picked = sel.filter(g => g.items.length);
  if (picked.length){
    lines.push("");
    lines.push("Ä°ÅŸaretlenen DavranÄ±ÅŸlar:");
    for (const g of picked){
      lines.push(`- ${g.title}`);
      for (const it of g.items){
        lines.push(`  â€¢ ${it}`);
      }
    }
  }

  const text = lines.join("\n");

  try{
    await navigator.clipboard.writeText(text);
    toast("KopyalandÄ± âœ“");
  }catch(e){
    alert("Kopyalama baÅŸarÄ±sÄ±z. TarayÄ±cÄ± izinlerini kontrol edin.");
  }
});

qs("#btnPdf").addEventListener("click", async () => {
  openModal();
  // default: meta fields off; date input stays disabled until toggle
  await buildAndPreviewPdf();
});

qs("#btnRebuildPdf").addEventListener("click", buildAndPreviewPdf);

qs("#btnDownloadPdf").addEventListener("click", () => {
  if (!lastBlobUrl){
    toast("Ã–nce PDFâ€™i oluÅŸturun.");
    return;
  }
  const a = document.createElement("a");
  a.href = lastBlobUrl;
  a.download = lastFileName || "FAST_S4_Gozlem_Raporu.pdf";
  document.body.appendChild(a);
  a.click();
  a.remove();
  toast("Ä°ndirme baÅŸlatÄ±ldÄ±");
});

// ESC to close
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape" && modalEl.classList.contains("show")){
    closeModal();
  }
});


    buildUI();
  </script>
</body>
</html>
